name: Deploy to Vercel

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Preview deployment for pull requests (no migrations, no production deploy)
  preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate Prisma client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Build application (no migrations for PRs)
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Deploy preview to Vercel
      run: |
        if [ -z "$VERCEL_TOKEN" ]; then
          echo "‚ö†Ô∏è  VERCEL_TOKEN not set. Skipping deployment."
          echo "üí° To enable deployments, add VERCEL_TOKEN, ORG_ID, and PROJECT_ID to GitHub Secrets."
          echo "üìñ See docs/GITHUB_ACTIONS_SETUP.md for instructions."
          exit 0
        fi
        npm install -g vercel
        # Check if vercel command exists first
        if ! command -v vercel &> /dev/null; then
          echo "‚ùå Vercel CLI not found after installation"
          exit 1
        fi
        
        if vercel --prebuilt --yes; then
          echo "‚úÖ Preview deployment successful"
        else
          echo "‚ùå Deployment failed. This may be due to:"
          echo "   - Invalid or expired VERCEL_TOKEN"
          echo "   - Incorrect ORG_ID or PROJECT_ID"
          echo "   - Missing Vercel project permissions"
          echo "üí° Check docs/GITHUB_ACTIONS_SETUP.md for troubleshooting"
          exit 0  # Don't fail the workflow, just skip deployment
        fi
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}

  # Production deployment only on push to main/master (with migrations)
  production:
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Generate Prisma client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Run database migrations (production only)
      run: npx prisma migrate deploy
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Build application
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        
    - name: Deploy to Vercel production
      run: |
        if [ -z "$VERCEL_TOKEN" ]; then
          echo "‚ö†Ô∏è  VERCEL_TOKEN not set. Skipping deployment."
          echo "üí° To enable deployments, add VERCEL_TOKEN, ORG_ID, and PROJECT_ID to GitHub Secrets."
          echo "üìñ See docs/GITHUB_ACTIONS_SETUP.md for instructions."
          exit 0
        fi
        npm install -g vercel
        if vercel --prod --prebuilt --yes; then
          echo "‚úÖ Production deployment successful"
        else
          echo "‚ùå Deployment failed. This may be due to:"
          echo "   - Invalid or expired VERCEL_TOKEN"
          echo "   - Incorrect ORG_ID or PROJECT_ID"
          echo "   - Missing Vercel project permissions"
          echo "üí° Check docs/GITHUB_ACTIONS_SETUP.md for troubleshooting"
          exit 0  # Don't fail the workflow, just skip deployment
        fi
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.PROJECT_ID }}
